/*!
 * angular-spa-security 
 * @version 1.2.1
 * @homepage https://github.com/JustMaier/angular-spa-security
 * @license MIT 
 * @license https://github.com/JustMaier/angular-spa-security/blob/master/LICENSE
 * 
 * @author  Justin Maier
 */
;angular.module("security",[]).constant("security.urls",{site:"/",manage:"/manage",join:"/api/account/register",login:"/token",logout:"/api/account/logout",forgotPassword:"/api/account/forgotpassword",resetPassword:"/api/account/resetpassword",setPassword:"/api/account/setPassword",confirmEmail:"/api/account/confirmEmail",userInfo:"/api/account/userInfo",changePassword:"/api/account/changePassword",externalLogins:"/api/account/externalLogins",manageInfo:"/api/account/manageInfo",registerExternal:"/api/account/registerExternal",addExternalLogin:"/api/account/addExternalLogin",removeLogin:"/api/account/removeLogin"}).factory("security.api",["$http","security.urls",function(e,d){var b={"Content-Type":"application/x-www-form-urlencoded"};var c=function(f){var g=function(n){var m="";var l,k,h,j;angular.forEach(n,function(o,i){if(o instanceof Array){for(j=0;j<o.length;++j){l=o[j];k=i+"["+j+"]";h={};h[k]=l;m+=g(h)+"&"}}else{if(o instanceof Object){angular.forEach(o,function(q,p){k=i+"["+p+"]";h={};h[k]=q;m+=g(h)+"&"})}else{if(o!==undefined&&o!==null){m+=encodeURIComponent(i)+"="+encodeURIComponent(o)+"&"}}}});return m.length?m.substr(0,m.length-1):m};return angular.isObject(f)&&String(f)!=="[object File]"?g(f):f};var a={getUserInfo:function(f){return e({url:d.userInfo,method:"GET",headers:{Authorization:"Bearer "+f}})},login:function(f){return e({method:"POST",url:d.login,data:c(f),headers:b})},logout:function(){return e({method:"POST",url:d.logout})},register:function(f){return e({method:"POST",url:d.join,data:f})},forgotPassword:function(f){return e({method:"POST",url:d.forgotPassword,data:f})},resetPassword:function(f){return e({method:"POST",url:d.resetPassword,data:f})},setPassword:function(f){return e({method:"POST",url:d.setPassword,data:f})},confirmEmail:function(f){return e({method:"GET",url:d.confirmEmail+"?code="+encodeURIComponent(f.code)+"&userId="+encodeURIComponent(f.userId)})},changePassword:function(f){return e({method:"POST",url:d.changePassword,data:f})},getExternalLogins:function(){return e({method:"GET",url:d.externalLogins+"?returnUrl="+encodeURIComponent(d.site)+"&generateState=true",isArray:true})},manageInfo:function(){return e({method:"GET",url:d.manageInfo+"?returnUrl="+encodeURIComponent(d.site)+"&generateState=false"})},registerExternal:function(f,g){return e({method:"POST",url:d.registerExternal,data:g,headers:{Authorization:"Bearer "+f}})},addExternalLogin:function(g,f){return e({method:"POST",url:d.addExternalLogin,data:{externalAccessToken:f},headers:{Authorization:"Bearer "+g}})},removeLogin:function(f){return e({method:"POST",url:d.removeLogin,data:f})}};return a}]).provider("security",["security.urls",function(b){var a=this;a.registerThenLogin=true;a.usePopups=false;a.urls={login:"/login",registerExternal:"/registerExternal",postLogout:"/login",home:"/"};a.apiUrls=b;a.events={login:null,logout:null,register:null,reloadUser:null,closeOAuthWindow:null};a.$get=["security.api","$q","$http","$location","$timeout",function(k,j,l,h,d){var c=null;var e=function(p){var u={},q,r,x,s,y,w,v;if(p===null){return u}q=p.split("&");for(var t=0;t<q.length;t++){r=q[t];x=r.indexOf("=");if(x===-1){s=r;y=null}else{s=r.substr(0,x);y=r.substr(x+1)}w=decodeURIComponent(s);v=decodeURIComponent(y);u[w]=v}return u};var m=function(p,q){if(p){if(p=="clear"){localStorage.removeItem("accessToken");sessionStorage.removeItem("accessToken");delete l.defaults.headers.common.Authorization}else{if(q){localStorage.accessToken=p}else{sessionStorage.accessToken=p}l.defaults.headers.common.Authorization="Bearer "+p}}return sessionStorage.accessToken||localStorage.accessToken};var o=function(p){if(p=="clear"){delete localStorage.associating;return}if(p){localStorage.associating=p}return localStorage.associating};var g=function(p){if(p=="clear"){delete localStorage.redirectTarget;return}if(p){localStorage.redirectTarget=p}return localStorage.redirectTarget};var n=function(p,r,s){var q=j.defer();if(p.error){q.reject({message:p.error})}else{if(m()&&o()){o("clear");g("clear");k.addExternalLogin(m(),p.access_token).success(function(){q.resolve()})}else{k.getUserInfo(p.access_token).success(function(t){if(t.hasRegistered){m(p.access_token,s);i.user=t;i.redirectAuthenticated(g()||a.urls.home);if(a.events.login){a.events.login(i,t)}q.resolve(i.user)}else{i.externalUser=t;i.externalUser.access_token=p.access_token;i.externalUser.provider=r;if(s!=null){localStorage.rememberMe=s}h.path(a.urls.registerExternal);q.reject()}})}}return q.promise};var f=function(){if(h.path().indexOf("access_token")!=-1){var p=e(h.path().substring(1));if(window.opener){window.opener.external_data=p;window.close()}else{var r=g();h.path(r||a.urls.home);var q=JSON.parse(localStorage.loginProvider);var s=false;if(localStorage.rememberMe){s=JSON.parse(localStorage.rememberMe);delete localStorage.rememberMe}delete localStorage.loginProvider;n(p,q,s)}}if(m()){m(m());k.getUserInfo(m()).success(function(t){i.user=t;if(a.events.reloadUser){a.events.reloadUser(i,t)}})}k.getExternalLogins().success(function(t){i.externalLogins=t})};var i=this;i.user=null;i.externalUser=null;i.externalLogins=[];i.login=function(q){var p=j.defer();q.grant_type="password";k.login(q).success(function(r){m(r.access_token,q.rememberMe);i.user=r;i.redirectAuthenticated(g()||a.urls.home);if(a.events.login){a.events.login(i,r)}p.resolve(i.user)}).error(function(r){p.reject(r)});return p.promise};i.loginWithExternal=function(q,t){var p=j.defer();if(a.usePopups){var s=window.open(q.url,"frame","resizeable,height=510,width=380");d.cancel(c);c=d(function r(){if(!s.closed){c=d(r,500);return}if(a.events.closeOAuthWindow){a.events.closeOAuthWindow(i,window.external_data)}if(typeof(window.external_data)==="undefined"){p.reject();return}var u=window.external_data;delete window.external_data;p.resolve(n(u,q,t.rememberMe))},500)}else{if(t!=null&&t.rememberMe!=null){localStorage.rememberMe=JSON.stringify(t.rememberMe)}localStorage.loginProvider=JSON.stringify(q);window.location.href=q.url}return p.promise};i.logout=function(){var p=j.defer();k.logout().success(function(){i.user=null;m("clear");g("clear");if(a.events.logout){a.events.logout(i)}h.path(a.urls.postLogout);p.resolve()}).error(function(q){p.reject(q)});return p.promise};i.register=function(q){var p=j.defer();k.register(q).success(function(){if(a.events.register){a.events.register(i)}if(a.registerThenLogin){i.login(q).then(function(r){p.resolve(r)},function(r){p.reject(r)})}else{p.resolve()}}).error(function(r){p.reject(r)});return p.promise};i.registerExternal=function(){var p=j.defer();if(!i.externalUser){p.reject()}else{k.registerExternal(i.externalUser.access_token,i.externalUser).success(function(){p.resolve(i.loginWithExternal(i.externalUser.provider));i.externalUser=null}).error(function(q){p.reject(q)})}return p.promise};i.forgotPassword=function(q){var p=j.defer();k.forgotPassword(q).success(function(r){p.resolve(r)}).error(function(r){p.reject(r)});return p.promise};i.resetPassword=function(q){var p=j.defer();k.resetPassword(q).success(function(r){p.resolve(r)}).error(function(r){p.reject(r)});return p.promise};i.setPassword=function(q){var p=j.defer();k.setPassword(q).success(function(){p.resolve()}).error(function(r){p.reject(r)});return p.promise};i.confirmEmail=function(q){var p=j.defer();k.confirmEmail(q).success(function(r){p.resolve(r)}).error(function(r){p.reject(r)});return p.promise};i.mangeInfo=function(){var p=j.defer();k.manageInfo().success(function(q){p.resolve(q)}).error(function(q){p.reject(q)});return p.promise};i.changePassword=function(q){var p=j.defer();k.changePassword(q).success(function(){p.resolve()}).error(function(r){p.reject(r)});return p.promise};i.addExternalLogin=function(q,r){var p=j.defer();k.addExternalLogin(q,r).success(function(){p.resolve()}).error(function(s){p.reject(s)});return p.promise};i.associateExternal=function(q,t){var p=j.defer();if(a.usePopups){var s=window.open(q.url,"frame","resizeable,height=510,width=380");d.cancel(c);c=d(function r(){if(!s.closed){c=d(r,500);return}if(a.events.closeOAuthWindow){a.events.closeOAuthWindow(i,window.external_data)}if(typeof(window.external_data)==="undefined"){p.reject();return}var u=window.external_data;delete window.external_data;p.resolve(n(u,q,data.rememberMe))},500)}else{localStorage.loginProvider=JSON.stringify(q);o(true);g(t||"/");window.location.href=q.url}return p.promise};i.removeLogin=function(q){var p=j.defer();k.removeLogin(q).success(function(r){p.resolve(r)}).error(function(r){p.reject(r)});return p.promise};i.authenticate=function(){if(m()){return}if(!g()){g(h.path())}h.path(a.urls.login)};i.redirectAuthenticated=function(p){if(!m()){return}if(g()){g("clear")}h.path(p)};f();return i}]}]);